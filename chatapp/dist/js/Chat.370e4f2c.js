(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["Chat"],{2711:function(t,e,s){"use strict";var n=s("575c"),i=s.n(n);i.a},2762:function(t,e,s){},"575c":function(t,e,s){},"5a0a":function(t,e,s){},"5a8c":function(t,e,s){"use strict";var n=s("2762"),i=s.n(n);i.a},"6cc5":function(t,e,s){"use strict";var n=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"avatar"},[s("img",{directives:[{name:"lazy",rawName:"v-lazy",value:t.imgurl,expression:"imgurl"}],attrs:{alt:""}})])},i=[],a={props:{imgurl:{type:String,default:""}}},o=a,r=(s("2711"),s("2877")),c=Object(r["a"])(o,n,i,!1,null,"28a6aad4",null);e["a"]=c.exports},"7aff":function(t,e,s){"use strict";var n=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"head-wrapper"},[s("div",{staticClass:"head-left",on:{click:t.leftClick}},[t._t("left")],2),s("div",{staticClass:"title"},[t._t("default",[t._v(t._s(t.title))])],2),s("div",{staticClass:"head-right",on:{click:t.rightClick}},[t._t("right")],2)])},i=[],a={props:{title:{type:String,default:""}},methods:{leftClick:function(){this.$emit("leftClick")},rightClick:function(){this.$emit("rightClick")}}},o=a,r=(s("b019"),s("2877")),c=Object(r["a"])(o,n,i,!1,null,"595ca198",null);e["a"]=c.exports},8455:function(t,e,s){},"8b38":function(t,e,s){"use strict";var n=s("5a0a"),i=s.n(n);i.a},"8ef0":function(t,e,s){"use strict";var n=s("8455"),i=s.n(n);i.a},a8c2:function(t,e,s){"use strict";s.r(e);var n=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"chat-wrapper"},[s("nav-head",{staticClass:"nav",attrs:{title:t.friendInfo.nickname},on:{leftClick:t.onBack},scopedSlots:t._u([{key:"left",fn:function(){return[s("i",{staticClass:"iconfont icon-arrow-left"})]},proxy:!0}])}),s("div",{staticClass:"chat-panel"},[s("cube-scroll",{ref:"scroll",attrs:{data:t.messageList,options:t.scrollOptions,"scroll-events":["scroll","scroll-end"]},on:{scroll:t.onScrollHandle,"scroll-end":t.handlePullingDown}},[s("div",{directives:[{name:"show",rawName:"v-show",value:t.isPullingDown,expression:"isPullingDown"}],staticClass:"pulling-down-Loading"},[s("cube-loading")],1),s("ul",{style:{"min-height":t.computedHeight+"px"}},[s("transition-group",{attrs:{name:"list"}},t._l(t.messageList,(function(t){return s("li",{key:t.time},[s("chat-item",{attrs:{chatInfo:t,showTime:t.isShowTime}})],1)})),0)],1)])],1),s("chat-input",{on:{handleMessage:t.sendMessage}})],1)},i=[],a=(s("99af"),s("d81d"),s("fb6a"),s("b64b"),s("96cf"),s("1da1")),o=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[t.showTime?s("div",{staticClass:"time"},[t._v(t._s(t.getTime))]):t._e(),s("div",{staticClass:"chat-item",class:t.chatInfo.isMine?"chat-mine":""},[s("div",{staticClass:"avatar-wrapper"},[s("avatar",{attrs:{imgurl:t.chatInfo.owner.avatar}})],1),s("div",{staticClass:"text-wrapper",class:t.chatInfo.isMine?"right-arrow blue-style":"left-arrow white-style"},[t._v(" "+t._s(t.chatInfo.content)+" ")])])])},r=[],c=s("6cc5"),l=s("7b2c"),u={props:{chatInfo:{type:Object,default:function(){}},showTime:{type:Boolean,default:!1}},components:{Avatar:c["a"]},computed:{getTime:function(){return Object(l["b"])(this.chatInfo.time)}}},h=u,f=(s("8b38"),s("2877")),g=Object(f["a"])(h,o,r,!1,null,"0e1e5195",null),d=g.exports,m=s("7aff"),p=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"chat-input-wrapper"},[s("input",{directives:[{name:"model",rawName:"v-model",value:t.message,expression:"message"}],staticClass:"chat-input",attrs:{type:"text"},domProps:{value:t.message},on:{input:function(e){e.target.composing||(t.message=e.target.value)}}}),s("div",{staticClass:"send-wrapper"},[s("div",{staticClass:"send-btn",on:{click:t.sendMessage}},[t._v("发送")])])])},w=[],v={data:function(){return{message:""}},methods:{sendMessage:function(){this.message&&(this.$emit("handleMessage",this.message),this.message="")}}},C=v,y=(s("5a8c"),Object(f["a"])(C,p,w,!1,null,"a4add048",null)),M=y.exports,b=s("2b61"),L=s("e20a"),I=18e4,T=7,$={data:function(){return{friendInfo:{},content:"",scrollOptions:{bounce:!0},messageList:[],newMsgCount:0,noMore:!1,isPullingDown:!1,oldScrollTop:0,computedHeight:0,showMessageCount:0}},components:{ChatItem:d,NavHead:m["a"],ChatInput:M},methods:{onBack:function(){this.$router.go(-1)},onPullingDown:function(){var t=this;if(this.noMore)this.$refs.scroll.forceUpdate();else{var e=this.$refs.scroll.scroll.scroller.clientHeight,s=this.history.slice(-(this.showMessageCount+T),-this.showMessageCount);s.length<T&&(this.noMore=!0),this.showMessageCount+=T,this.messageList=s.concat(this.messageList),this.$nextTick((function(){var s=t.$refs.scroll.scroll.scroller.clientHeight;t.$refs.scroll.scrollTo(0,-(s-e))}))}},onScrollHandle:function(t){t.y>40&&(this.isPullingDown=!0)},handlePullingDown:function(t){this.isPullingDown&&(this.onPullingDown(),this.isPullingDown=!1)},onListenMessage:function(t){console.log(t);var e=t.chatId,s=t.content,n=t.create,i=t.fromUser,a=new Date(n).getTime(),o=this.messageList.length,r=!(o>0)||a-this.messageList[o-1].time>I,c={chatId:e,content:s,time:new Date(a).getTime(),owner:i,isMine:!1,isShowTime:r};this.messageList.push(c),this.history.push(c);var l=b["a"].read("historyList");l[this.friendInfo.account]=this.history,b["a"].write("historyList",l),this.showMessageCount+=1,this.scrollToEnd()},sendMessage:function(t){var e=this;return Object(a["a"])(regeneratorRuntime.mark((function s(){var n,i,a,o,r,c,l,u,h,f;return regeneratorRuntime.wrap((function(s){while(1)switch(s.prev=s.next){case 0:return s.next=2,Object(L["e"])({toUser:e.friendInfo._id,content:t});case 2:n=s.sent,200===n.code?(i=n.result,a=i.content,o=i.chatId,r=i.create,c=new Date(r).getTime(),l=e.messageList.length,u=!(l>0)||c-e.messageList[l-1].time>I,h={content:a,chatId:o,time:c,owner:b["a"].read("userInfo"),isMine:!0,isShowTime:u},e.messageList.push(h),e.history.push(h),f=b["a"].read("historyList"),f[e.friendInfo.account]=e.history,b["a"].write("historyList",f),e.showMessageCount+=1,e.scrollToEnd()):e.$createToast({type:"warn",txt:"发送失败",time:500}).show();case 4:case"end":return s.stop()}}),s)})))()},getNewMessage:function(){var t=this;return Object(a["a"])(regeneratorRuntime.mark((function e(){var s,n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,Object(L["c"])({toUser:t.friendInfo._id,count:t.newMsgCount});case 2:s=e.sent,t.newMsgCount=0,200===s.code?(t.messageList=t.formatList(s.result),t.history=t.history.concat(t.messageList),n=b["a"].read("historyList"),n[t.friendInfo.account]=t.history,b["a"].write("historyList",n),t.showMessageCount=t.messageList.length,t.scrollToEnd()):t.$createToast({type:"warn",txt:"获取消息失败",time:1e3}).show();case 5:case"end":return e.stop()}}),e)})))()},getHistoryMessage:function(){this.history.length<8?(this.messageList=this.history.slice(-T),this.noMore=!0):this.messageList=this.history.slice(-T),this.showMessageCount=this.messageList.length,this.scrollToEnd()},formatList:function(t){return t.map((function(t,e,s){var n,i=new Date(s[e].create).getTime();if(0===e)n=!0;else{var a=new Date(s[e-1].create).getTime();n=i-a>I}return{content:t.content,chatId:t.chatId,owner:t.fromUser,time:i,isMine:t.isMine,isShowTime:n}}))},scrollToEnd:function(){var t=this,e=setTimeout((function(){var s=t.$refs.scroll,n=s.scroll.maxScrollY;s.scrollTo(0,n),clearTimeout(e)}),20)}},created:function(){var t=this;Object.keys(this.$route.params).length?(b["a"].write("currentChatPerson",this.$route.params.personInfo),this.friendInfo=this.$route.params.personInfo,this.newMsgCount=this.$route.params.newMsgCount):this.friendInfo=b["a"].read("currentChatPerson");var e=b["a"].read("historyList"),s=this.friendInfo.account;this.history=e[s]||[],this.newMsgCount>0?this.getNewMessage():this.getHistoryMessage(),this.$bus.$on("currentChatMessage",(function(e){t.onListenMessage(e)}))},mounted:function(){this.computedHeight=this.$refs.scroll.$el.clientHeight+1},beforeDestroy:function(){this.$bus.$off("currentChatMessage")}},_=$,k=(s("8ef0"),Object(f["a"])(_,n,i,!1,null,"803cdaf6",null));e["default"]=k.exports},b019:function(t,e,s){"use strict";var n=s("b8d1"),i=s.n(n);i.a},b8d1:function(t,e,s){}}]);
//# sourceMappingURL=Chat.370e4f2c.js.map